#include "precomp.h"
#include "Session.h"
#include "DX8Sound.h"
#include "Segment.h"
#include "Script.h"
#include "ThemeMgr2.h"

/////////////////////////////////////////////////////////////////////////////////////////
////////////////////////// cc_ThemeSession::cc_ThemeSession() ///////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
cc_ThemeSession::cc_ThemeSession(cc_ThemeMgr2 *mgr)
:	m_mgr(mgr),
	m_Script(0),
	m_Segment(0),
	m_bMuted(false)
{
}

/////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////// cc_ThemeSession::changeTheme() /////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
void cc_ThemeSession::changeTheme(const char *scriptName, const char *newTheme)
{
	TRACK_FUNC(cc_ThemeSession::changeTheme());
	m_Script = m_mgr->scriptMgr()->getScript(scriptName);

	// Проверим, не является ли строка newTheme пустой
	if ((newTheme==0) || (*newTheme=='\0'))
	{
		m_Segment = m_Script->getSegment();
	}
	else
	{
		m_Segment = m_mgr->segmentMgr()->getSegment(newTheme);
	}
	m_mgr->noticeThemeChange(this);
}

/////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////// cc_ThemeSession::mute() ////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
void cc_ThemeSession::mute(bool bMute)
{
	TRACK_FUNC(cc_ThemeSession::mute());
	if (m_bMuted != bMute)
	{
		m_mgr->noticeThemeChange(this);
		m_bMuted = bMute;
	}
}

/////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////// cc_ThemeSession::Release() ///////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
void cc_ThemeSession::Release()
{
	m_mgr->deleteSession(this);
	delete this;
}

/////////////////////////////////////////////////////////////////////////////////////////
////////////////////////// cc_ThemeSession::getPlayingScript() //////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
cc_SndScript *cc_ThemeSession::getPlayingScript()
{
	if (m_bMuted) return 0;
	return m_Script;
}

/////////////////////////////////////////////////////////////////////////////////////////
///////////////////////// cc_ThemeSession::getPlayingSegment() //////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
cc_Segment *cc_ThemeSession::getPlayingSegment()
{
	if (m_bMuted) return 0;
	return m_Segment;
}